# "RC Car Autonomous Driving Project"


## 1. 프로젝트 소개 (Introduction)

이 프로젝트는 Raspberry Pi 5와 Arduino UNO를 기반으로 한 RC카 자율주행 시스템입니다.

카메라를 통해 라인을 실시간으로 인식하고, 아두이노가 해당 정보를 받아 차량의 방향과 속도를 제어함으로써, RC카가 경로를 스스로 따라 주행할 수 있도록 설계되었습니다.

사용자는 조종기의 CH7 스위치를 통해 수동 주행과 자율 주행 모드 간의 전환이 가능하며, 라인을 놓치는 경우에도 후진 및 복귀 알고리즘을 통해 경로를 다시 찾도록 구현되어 있습니다.

또한, 자율주행 모드에서 라인의 편차가 작을 경우, 차량이 좌우로 가볍게 진동하며 주행하는 Zigzag 모드를 적용하여 직진 안정성을 향상시키고, 단조로운 움직임에 따른 트랙 이탈을 방지하도록 구현하였습니다.

이 프로젝트는 임베디드 시스템 개발, 컴퓨터 비전 처리, 하드웨어 제어, 실시간 통신의 통합적 학습을 목표로 하고 있습니다.


---    
--- 


## 2. 자율주행 데모 영상 (Demo Video)  
![자율주행 데모](https://i.imgur.com/E7pzR8D.gif)

![중간 주행](https://i.imgur.com/9A8NuqC.gif)

--- 
---  

## 3. 프로젝트 개요 및 목표 (Overview & Objectives)

이 프로젝트는 RC카에 수동주행 기능과 자율주행 기능을 탑재하는 것을 목표로 하며, 방향에 따른 LED 제어를 실시간으로 ON/OFF하는 동작을 구현했습니다.
구조는 다음과 같이 구성되어 있습니다.


### 📌 전체 시스템 구성

- **Raspberry Pi 5**  
  - PiCamera2로 실시간 영상 촬영  
  - OpenCV 기반 라인 인식 알고리즘 적용  
  - 라인 중심 좌표를 계산하여 시리얼로 아두이노에 전송  
  - WebSocket을 통해 실시간 영상도 전송 가능

- **Arduino UNO**  
  - Raspberry Pi로부터 수신한 라인 중심값을 바탕으로 PWM 신호 생성  
  - 서보모터(조향)와 ESC(속도) 제어  
  - CH7 채널 입력을 통해 수동/자동 주행 모드 전환  
  - 자율주행 중 라인 손실 시 후진 및 복귀 로직 수행  
  - 지그재그 주행 알고리즘 내장


### 🎯 세부 목표

- 라인을 안정적으로 인식하기 위한 영상 전처리 및 중심좌표 검출  
- 실시간 라인 중심값 기반의 PD 제어 조향 알고리즘 구현  
- 라인 손실 상황에서 후진 → 복귀 로직을 통해 자동 복원  
- 직진 구간에서 미세한 조향 반복을 통한 **지그재그 주행 알고리즘 적용**으로 안정성 향상  
- 주행 중 좌/우 방향 표시용 LED 연동  
- 수동/자율 모드 전환 시 시스템 상태 유지 및 안전 제어


> 이 프로젝트는 단순 라인트레이싱을 넘어서, 실제 주행 도중 발생할 수 있는 다양한 상황(라인 미검출, 곡선, 정지 등)을 고려한 제어 알고리즘을 설계하고 적용하였습니다.

---
--- 

## 4. 전체 시스템 구성도 (System Architecture)

### 📌 시스템 블록 다이어그램


이 시스템은 다음과 같은 흐름으로 작동합니다:

1. **PiCamera2**  
   - 실시간으로 트랙(라인)을 촬영하여 Raspberry Pi에 영상 데이터 전달

2. **Raspberry Pi 5**  
   - OpenCV를 이용한 라인 인식 알고리즘 수행  
   - 라인의 중심좌표 계산  
   - 계산된 중심값을 **Serial (UART)**로 Arduino에 전송  
   - 동시에 **WebSocket**을 통해 실시간 영상도 송출 가능

3. **Arduino UNO**  
   - Raspberry Pi로부터 받은 중심값을 바탕으로 **PWM 제어 신호 생성**  
   - 서보모터(조향), ESC(속도) 제어  
   - 라인 손실 시 후진 → 복귀 알고리즘 실행  
   - 수동/자율 모드 전환 및 Zigzag 주행 알고리즘 포함  
   - 좌/우/후진 방향에 따라 LED 제어로 진행 방향 표시


4. **Servo & ESC**  
   - Servo: 좌/우 방향 조향  
   - ESC: 전진/후진 속도 제어


---  
--- 


## 5. 사용 기술 스택 (Tech Stack)

이 프로젝트는 하드웨어와 소프트웨어가 긴밀하게 통신하는 구조로, 아래와 같은 기술이 사용되었습니다.

### 🔹 Raspberry Pi 5 (Python 기반)
Python 3.11

Picamera2: 카메라를 통한 실시간 영상 캡처

OpenCV: 라인 중심 검출, 노이즈 제거, 컨투어 기반 객체 인식

asyncio + WebSocket: 실시간 영상 스트리밍 (브라우저 대응)

pyserial: UART 기반 아두이노와 시리얼 통신

### 🔹 Arduino UNO (C++ 기반)
Arduino IDE: 펌웨어 개발 및 업로드

Servo 라이브러리: 서보모터(PWM) 제어

PinChangeInterrupt 라이브러리: PPM 신호 인터럽트 처리

PWM 제어: 조향(서보) 및 속도(ESC) 조절

PD 제어 알고리즘: 라인 중심 오차 기반의 조향 계산

Zigzag 주행 알고리즘: 직진 시 미세 조향 반복을 통한 안정성 확보

라인 손실 복구 로직: 선 미검출 시 후진 후 재진입

LED 제어: 좌/우 방향, 후진 상황 표시용

### 🔹 통신 및 영상 전송
UART Serial 통신: Raspberry Pi → Arduino로 라인 중심 좌표 전송

WebSocket: Raspberry Pi → 웹 클라이언트로 영상 전송

### 🔹 하드웨어 구성 요소
PiCamera2: 640×480 해상도, 프레임 단위 영상 인식

Servo Motor: 좌우 방향 조향 제어

ESC + 브러시리스 모터: 전진/후진 속도 제어

LED: 좌우 및 후진 방향 시각화

### 🔹 개발 및 문서화 도구
Arduino IDE: 펌웨어 작성 및 업로드

VSCode: Raspberry Pi 측 Python 코드 작성 및 관리

GitHub: 코드 버전 관리 및 프로젝트 문서화

Imgur: GIF 기반 시각 자료 업로드 및 README 연동


### 🧠 시스템 구성 요소

| 구성 | 기술 스택 |
|------|-----------|
| **주행 제어** | Arduino UNO, C++, Servo 라이브러리, PinChangeInterrupt |
| **영상 처리** | Raspberry Pi 5, PiCamera2, Python, OpenCV |
| **통신** | USB 시리얼 (PySerial), WebSocket (Python websockets) |
| **실시간 스트리밍** | OpenCV → WebSocket 전송 (브라우저 수신) |

 

### 📝 사용된 언어 및 주요 라이브러리

#### 🔹 Raspberry Pi (Python)
- `cv2` (OpenCV): 영상 처리 및 라인 인식
- `asyncio`: 비동기 프레임 처리 및 서버 제어
- `serial`: 아두이노와 시리얼 통신
- `websockets`: 클라이언트에 영상 전송 (WebSocket 서버)

#### 🔹 Arduino UNO (C++)
- `Servo.h`: 서보 및 ESC 제어
- `PinChangeInterrupt.h`: 수신 PWM 신호 인터럽트 처리
- 사용자 정의 알고리즘: 후진 복귀, PD 제어, 지그재그 주행


### 🧪 개발 환경

- Arduino IDE (C++)
- Raspberry Pi OS (64-bit)
- Python 3.11


---  
--- 


## 6. 하드웨어 구성 (Hardware Components)

| 구성 요소                             |  설명                                                                     
| ------------------------------------- | -------------------------------------------------------                   
| **RC카 프레임 + 바퀴**                | 브러시리스 모터 장착형 RC카 프레임 (서스펜션 포함)                          
| **Raspberry Pi 5**                    | 영상 처리 및 중심 좌표 계산, Arduino로 전송 (UART), WebSocket 영상 스트리밍 
| **Pi Camera Module**                  | 실시간 트랙 인식 (640×480 해상도, Picamera2 사용)                          
| **Arduino UNO**                       | PWM 기반 모터/조향 제어, 후진 복귀 로직, Zigzag 알고리즘, LED 표시          
| **ESC (Electronic Speed Controller)** | 브러시리스 모터 속도 제어 (Arduino PWM 제어 신호 수신)                      
| **서보모터 (Steering Servo)**         | RC카의 좌/우 방향 조향 제어 (PWM 기반)                                      
| **RadioLink AT9 송신기**              | 수동 조작, CH7 스위치를 통한 자율/수동 모드 전환 신호 송신                   
| **RadioLink R9DS 수신기**             | AT9에서 송신된 PWM 신호 수신, 특히 CH7 채널을 Arduino로 전달                
| **LED (좌/우 방향, 후진 표시용)**     | 실시간 방향 조향 및 후진 시 상태 시각화 표시 (디지털 출력 제어)              
| **배터리 팩 (7.4V\~12V)**             | Raspberry Pi 및 모터 시스템에 전원 공급       
| **점퍼 케이블 / 브레드보드**          | 각 하드웨어 간 연결 및 프로토타이핑에 사용                                
| **UART 시리얼 케이블**                | Raspberry Pi ↔ Arduino 간 중심좌표 데이터 송수신 (TX/RX 연결)        


---
--- 


## 🧩 7. 소프트웨어 구성 (Software Architecture)

이 프로젝트는 Raspberry Pi와 Arduino가 역할을 분담하며 동작하는 구조로, 소프트웨어는 다음과 같이 구성되어 있습니다.


### 🔹 Raspberry Pi (Python)

**📁 stream_ws_bidir.py**

- `PiCamera2`로 실시간 영상 캡처
- `OpenCV`를 이용한 라인 중심 검출
- 라인 중심 좌표를 **USB 시리얼**을 통해 아두이노로 전송
- 영상 프레임을 WebSocket으로 전송하여 클라이언트에 실시간 스트리밍 제공

> 💡 핵심 기능: 비전 처리 + 통신 + 웹 영상 송출


### 🔹 Arduino UNO (C++)

**📁 RC_arduino.ino**

- Raspberry Pi로부터 **라인 중심 좌표** 수신
- PD 제어 및 지그재그 주행 알고리즘으로 **조향 및 속도 제어**
- **라인 미검출 시 후진 복귀 로직** 수행
- CH7 스위치를 통해 **수동/자율 모드 전환**
- 주행 방향에 따라 **좌/우 깜빡이 LED 제어**
- **인터럽트 기반 PWM 측정**으로 신속한 RC 입력 감지

> 💡 핵심 기능: 자율주행 로직 + 모드 전환 + 하드웨어 제어


---
---


## 8. 라즈베리파이 & 아두이노 역할 (Raspberry Pi & Arduino Integration)

> 자율주행 시스템은 라즈베리파이와 아두이노가 각각의 역할을 분담하여 협력적으로 작동하도록 설계되었습니다.

### 🔹 Raspberry Pi 5
- PiCamera2를 이용해 실시간 영상 캡처
- OpenCV 기반 라인 중심 좌표 검출
- 중심 좌표를 UART 시리얼로 Arduino에 전송
- WebSocket을 통해 실시간 영상 스트리밍 제공

### 🔹 Arduino UNO
- Raspberry Pi로부터 수신한 중심 좌표 기반으로 주행 방향 판단
- 서보모터(PWM)로 조향, ESC로 속도 제어
- PD 제어 및 Zigzag 주행 알고리즘 수행
- 라인 손실 시 후진 → 복귀 알고리즘 실행
- CH7 채널 신호로 수동/자율 주행 전환 판단
- 방향 및 후진 상태에 따른 실시간 LED 점등 제어


---
---


## 9. 라인 검출 및 자율주행 알고리즘 설명 (Line Detection & Driving Logic)

> 이 프로젝트는 PiCamera2를 통해 실시간으로 영상을 캡처하고, OpenCV를 이용해 라인을 인식합니다. 인식된 라인의 중심 좌표를 바탕으로 Arduino가 조향(PWM)과 속도를 제어합니다.


### 🎥 라인 검출 알고리즘 (Python - Raspberry Pi)

`stream_ws_bidir.py` 내 `detect_line_center()` 함수에서 다음과 같은 과정을 거칩니다:

1. **Grayscale 변환**  
   → 색상 정보 제거로 라인 대비 강조

2. **Gaussian Blur 적용**  
   → 반사광/노이즈 완화

3. **Otsu Thresholding**  
   → 자동 임계값 이진화 (흰 배경 + 검은 라인 강조)

4. **Morphological 연산**  
   → 노이즈 제거 및 끊어진 라인 복원

5. **ROI 설정**  
   → 하단 40% 영역만 분석하여 처리 속도 및 정확도 향상

6. **Contour 분석**  
   → 가장 넓은 컨투어를 기준으로 라인 중심 좌표(cx) 계산

7. **중심값 시리얼 전송**  
   → `"{cx}\n"` 형식으로 아두이노에 실시간 전송


### 🚗 자율주행 제어 알고리즘 (C++ - Arduino)

`RC_arduino.ino`에서 다음과 같은 로직으로 주행을 제어합니다:

#### 1. **PD 제어 (중심 오차 기반)**  
- `error = 320 - rawCenter`  
- `control = Kp * error + Kd * (이전 오차 변화량)`  
- 계산된 control 값으로 **PWM 조향값 조절**

#### 2. **지그재그 주행 알고리즘**
- 중심 오차가 일정 이하이면 직진 판단
- 좌/우로 100μs씩 주기적으로 방향을 토글하여 **지그재그로 미세조정**,  단조로운 움직임에 따른 트랙 이탈을 방지

#### 3. **후진 복귀 로직**
- 중심값이 일정 시간 동안 `-1`이면 **라인 상실 판단**
- 일정 시간 후 **후진 시작 → 라인 재인식 → 전진 복귀**

#### 4. **LED 방향등 연동**
- 좌회전 시 왼쪽 LED, 우회전 시 오른쪽 LED 점등
- 후진 시 양쪽 LED 점등


> 이러한 알고리즘은 단순 추종을 넘어서, 곡선 주행, 라인 손실, 경로 복구 등 **다양한 실제 상황에 대응할 수 있도록 설계**되어 있습니다.


--- 
---


## 10. 코드 설명 (Key Code Explanation)

📌 stream_ws_bidir.py, main.ino 에서 주요 함수와 흐름 요약 설명 추가 예정



---
---  



## 11. 문제 해결 및 시행착오 기록 (Challenges & Iterative Improvements)

| 문제 상황                 | 원인 / 현상                                        | 해결 조치                                    | 결과                     |
| --------------------- | ---------------------------------------------- | ---------------------------------------- | ---------------------- |
| \[①] 카메라 지연으로 자율주행 실패 | USB 웹캠 + MJPEG 사용, 지연 0.5초 이상                  | `PiCamera2` + `WebSocket` 영상 스트리밍 도입     | 지연 0.05초 이하, 실시간 주행 가능 |
| \[②] 반사광 오인식          | 밝은 영역을 라인으로 오인, 후진/전진 반복                       | `Gaussian Blur` + `Otsu Thresholding` 적용 | 반사광 필터링, 인식 안정화        |
| \[③] 라인 미검출 시 오작동     | 선을 놓치면 방향 판단 실패 → 무작위 움직임                      | 반대 방향으로 후진 후 선 재인식 시 전진 복귀               | 미검출 상황에서도 안정적 경로 복귀    |
| \[④] 수동/자율 모드 전환 지연   | `CH7` 신호 충돌, 후진 상태 미정리                         | `PinChangeInterrupt`로 신호 처리 + 상태 초기화     | 전환 반응성 향상 및 안정 동작 확보   |
| \[⑤] PWM 값 오류         | 속도 부족 또는 급발진으로 차체 손상                           | 인터럽트 기반 `PWM 측정` 및 최적값 설정                | 부드러운 가속, 안전한 주행 가능     |
| \[⑥] 직진 중 선 이탈        | 중심 오차가 작을 때 선을 놓침                              | `Zigzag 알고리즘`으로 미세 조향 보정                 | 선 추종 안정성 증가, 탈선 방지     |
| \[⑦] 곡선 구간 회전 부족      | 회전 반응이 부족하여 커브 이탈                              | `steerRange` 확대 + `Expo 조향` 적용           | 급커브에서도 안정적인 코너링 유지     |
| \[⑧] 범퍼 오인식 문제        | **정상적인 RC카 조립 상태**에서도 카메라 하단에 범퍼가 잡혀 라인으로 오인식됨 | 카메라를 상단으로 위치 조정 및 고정                     | 프레임 내 라인만 인식, 오작동 방지   |




---
---



## 12. 팀원 소개 및 기여도 (Team & Contributions)

### 박기주 (Raspberry Pi / Vision / 상위 로직 담당)
| 기능/내용                        | 상세 설명                                                |
| ---------------------------- | ---------------------------------------------------- |
| **카메라 스트리밍 구현**              | Picamera2 + OpenCV + WebSocket을 이용해 실시간 영상 전송 시스템 구현 |
| **WebSocket 양방향 통신 설계**      | 영상 전송 + 라인 좌표 송수신을 위한 비동기 웹소켓 구조 설계 및 구현             |
| **라인 중심 검출 알고리즘**            | 하단 70% ROI 기반으로 이진화, 윤곽선 검출, 중심좌표 계산 수행              |
| **라인 중심 좌표 시리얼 송신**          | `serial.write(f"{cx}\n")`로 라인 중심 좌표를 Arduino로 전송     |
| **자율주행 판단 로직 설계**            | `straightThreshold`, `zigzag`, `후진→재진입` 판단 흐름 전체 설계  |
| **PWM 중심값 설정**               | 기준값 `pwmCenter = 1500` 설정 및 시스템 설계 기준 제공             |
| **PWM 반응 계수 설정**             | `forwardFactor`, `backwardFactor` 계수를 실험 기반으로 최적화    |
| **LED 방향 시스템 필요성 제안**        | error 기반 LED 방향 피드백 아이디어 제안                          |
| **조명 환경 실험 및 threshold 테스트** | 다양한 조도 환경에서 라인 인식 정확도 향상을 위한 threshold 실험 반복         |


---  

### 황주옥 (Arduino / 하드웨어 / 하위 제어 담당)
| 기능/내용                   | 상세 설명                                                  |
| ----------------------- | ------------------------------------------------------ |
| **라인 검출 ROI 조정 제안**     | 하단 70% ROI에서 발생한 노이즈 문제를 해결하기 위해 40%로 조정 제안            |
| **라인 좌표 시리얼 수신 및 파싱**   | `Serial.readStringUntil()` 사용하여 Pi로부터 중심좌표 수신 및 정수로 변환 |
| **PWM 출력 로직 구현**        | `writeMicroseconds()`로 서보/ESC에 PWM 신호 적용 (실제 주행 작동 처리) |
| **자율주행 PWM 계산 로직 구현**   | `error` 기반 steer/throttle PWM 계산 알고리즘 작성               |
| **조향 민감도 파라미터 조정**      | `steerRange`, `steerExpo` 등 곡선 조향 반응 제어 파라미터 설정        |
| **CH7 모드 전환 조건 분석**     | 수동/자율 모드 전환을 위한 CH7 입력 신호 범위 기준 분석                     |
| **모드별 PWM 분기 처리 로직 구현** | `manualMode` 여부에 따라 다른 제어 흐름으로 분기하는 로직 구현              |
| **LED 실시간 방향 시스템 구현**   | 조향 및 후진 상황에 따라 좌/우/후진 LED 점등 로직 구현 (과제 필수 항목)          |
| **하드웨어 회로 구성 및 핀 설계**   | ESC, 서보, LED 핀 배치 및 보호회로 포함 전체 하드웨어 설계 구성              |



---  
---


## 13. 향후 계획 (Future Plans)

Object Detection 기능 추가 (신호등, 장애물)

OTA 업데이트 기능 구현

앱과 연동한 수동 제어 시스템 개발


--- 
---


## 14. 마무리 및 회고 (Conclusion & Retrospective)

팀워크를 통한 문제 해결 경험

실시간 시스템 동기화의 어려움과 개선 방향 인식

추후 다양한 AI 기술 접목 가능성 확인

